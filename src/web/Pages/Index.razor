@page "/"
@inject HttpClient Http
@inject IJSRuntime JS
@using System.Text.RegularExpressions

<PageTitle>Smart Trader Dashboard</PageTitle>

<div class="container p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üöÄ Smart Trader AI <span class="fs-6 text-muted">| Dashboard Pro</span></h3>
        <span class="badge bg-success">Online</span>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="input-group mb-4 shadow-sm">
        <input type="text" @bind="tickerInput" class="form-control" placeholder="Ex: WEGE3" @onkeyup="HandleKey" />
        <button class="btn btn-primary" @onclick="AddFavorite">Monitorar Ativo</button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (assets != null && assets.Any())
    {
        <div class="card shadow-sm border-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Ativo</th>
                        <th>Pre√ßo</th>
                        <th>P/L</th>
                        <th>Resumo IA (50w)</th>
                        <th>Not√≠cias & Fontes</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in assets)
                    {
                        <tr>
                            <td class="fw-bold">@item.Ticker</td>
                            <td>R$ @(item.Price.ToString("N2"))</td>
                            <td>@(item.PeRatio.ToString("N2"))</td>
                            
                            <td class="small" style="max-width: 300px;">
                                @if (item.AiAnalysis.Contains("429"))
                                {
                                    <span class="text-warning fw-bold">‚ö†Ô∏è @item.AiAnalysis</span>
                                }
                                else if (item.AiAnalysis.Contains("Erro"))
                                {
                                    <span class="text-danger">@item.AiAnalysis</span>
                                }
                                else
                                {
                                    @item.AiAnalysis
                                }
                                <br/>
                                <button class="btn btn-link btn-sm p-0 mt-1 text-decoration-none fw-bold" 
                                        @onclick="() => OpenModal(item)">
                                    üìä Ver An√°lise Completa
                                </button>
                            </td>

                            <td class="small text-muted" style="max-width: 300px; font-size: 0.9rem;">
                                @((MarkupString)FormatNews(item.NewsSummary))
                            </td>

                            <td>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => Remove(item.Ticker)">X</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (selectedAsset != null)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">üìà An√°lise Profunda: <strong>@selectedAsset.Ticker</strong></h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body" style="white-space: pre-wrap; font-family: sans-serif; line-height: 1.6;">
                    @((MarkupString)FormatFullReport(selectedAsset.FullReport))
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string tickerInput = "";
    private List<AssetDto>? assets;
    private AssetDto? selectedAsset;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try { assets = await Http.GetFromJsonAsync<List<AssetDto>>("api/favorites"); }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; }
    }

    private async Task AddFavorite()
    {
        if (string.IsNullOrWhiteSpace(tickerInput)) return;
        await Http.PostAsync($"api/favorites/{tickerInput}", null);
        tickerInput = "";
        await LoadData();
    }

    private async Task Remove(string ticker)
    {
        await Http.DeleteAsync($"api/favorites/{ticker}");
        await LoadData();
    }

    private async Task HandleKey(KeyboardEventArgs e) { if (e.Key == "Enter") await AddFavorite(); }

    private void OpenModal(AssetDto asset) => selectedAsset = asset;
    private void CloseModal() => selectedAsset = null;

    // --- FORMATA√á√ÉO VISUAL (LINKS E MARKDOWN) ---

    private string FormatNews(string text)
    {
        if (string.IsNullOrEmpty(text)) return "Sem not√≠cias.";
        
        // 1. Quebra linhas
        var html = text.Replace("\n", "<br/>");

        // 2. Transforma [N] http://url em apenas [N] clic√°vel
        // Grupo 1 = [N]
        // Grupo 2 = URL
        string pattern = @"(\[\d+\])\s*(https?://[^\s<]+)";
        
        html = Regex.Replace(html, pattern, m => 
            // Link envolve o n√∫mero, com cor prim√°ria (azul) e negrito
            $"<a href=\"{m.Groups[2].Value}\" target=\"_blank\" class=\"text-primary fw-bold text-decoration-none px-1\" title=\"Abrir Fonte\">{m.Groups[1].Value}</a>"
        );

        return html;
    }

    private string FormatFullReport(string text)
    {
        if (string.IsNullOrEmpty(text)) return "Carregando detalhes...";
        // Suporte a Negrito (**texto**)
        var html = Regex.Replace(text, @"\*\*(.*?)\*\*", "<b>$1</b>");
        return html;
    }

    public class AssetDto
    {
        public string Ticker { get; set; } = "";
        public decimal Price { get; set; }
        public decimal PeRatio { get; set; }
        public decimal DyPercentage { get; set; }
        public string AiAnalysis { get; set; } = "";
        public string FullReport { get; set; } = "";
        public string NewsSummary { get; set; } = "";
    }
}