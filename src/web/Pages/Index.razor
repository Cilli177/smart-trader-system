@page "/"
@inject HttpClient Http
@inject IJSRuntime JS
@using System.Text.RegularExpressions

<PageTitle>Smart Trader Dashboard</PageTitle>

<style>
    /* Estilo "Clean Finance" inspirado na sua refer√™ncia */
    .price-tag {
        font-family: 'Segoe UI', sans-serif;
        font-weight: 700;
        color: #212529;
        font-size: 1.1rem;
    }
    .ticker-tag {
        font-weight: 800;
        color: #1a1a1a;
        font-size: 1rem;
    }
    .status-header {
        font-weight: 700;
        font-size: 0.95rem;
        margin-right: 6px;
    }
    .status-body {
        color: #495057;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    .news-link {
        font-size: 0.85rem;
        text-decoration: none;
        color: #6c757d;
        transition: color 0.2s;
    }
    .news-link:hover {
        color: #0d6efd;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0">üöÄ Smart Trader AI</h3>
            <span class="text-muted small">Monitoramento em Tempo Real</span>
        </div>
        <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill">
            ‚óè Sistema Online
        </span>
    </div>

    <div class="input-group mb-4 shadow-sm">
        <input type="text" @bind="tickerInput" class="form-control border-0 py-3" placeholder="Digite o ativo (ex: WEGE3)..." @onkeyup="HandleKey" />
        <button class="btn btn-primary px-4 fw-bold" @onclick="AddFavorite">MONITORAR</button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (assets != null && assets.Any())
    {
        <div class="card shadow-sm border-0 rounded-3 overflow-hidden">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light border-bottom">
                    <tr>
                        <th class="ps-4 text-secondary text-uppercase small fw-bold py-3">Ativo</th>
                        <th class="text-secondary text-uppercase small fw-bold">Cota√ß√£o</th>
                        <th class="text-secondary text-uppercase small fw-bold">P/L</th>
                        <th class="text-secondary text-uppercase small fw-bold" style="width: 40%;">Status do Algoritmo</th>
                        <th class="text-secondary text-uppercase small fw-bold">Fontes</th>
                        <th class="text-end pe-4"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in assets)
                    {
                        <tr>
                            <td class="ps-4">
                                <div class="ticker-tag">@item.Ticker</div>
                                <div class="small text-muted" style="font-size: 0.75rem;">B3 S.A.</div>
                            </td>

                            <td>
                                <div class="price-tag">R$ @(item.Price.ToString("N2"))</div>
                            </td>

                            <td>
                                <span class="badge bg-light text-dark border">@(item.PeRatio.ToString("N2"))</span>
                            </td>
                            
                            <td class="py-3">
                                @((MarkupString)RenderSmartStatus(item.AiAnalysis))
                                
                                <div class="mt-1">
                                    <button class="btn btn-link btn-sm p-0 text-decoration-none fw-bold text-primary" 
                                            style="font-size: 0.8rem;"
                                            @onclick="() => OpenModal(item)">
                                        Ver Relat√≥rio Completo ‚Üí
                                    </button>
                                </div>
                            </td>

                            <td>
                                @((MarkupString)FormatNewsCompact(item.NewsSummary))
                            </td>

                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-light text-danger border-0" @onclick="() => Remove(item.Ticker)" title="Remover">
                                    ‚úï
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (selectedAsset != null)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">üìä Raio-X: @selectedAsset.Ticker</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body pt-2">
                    <div class="p-3 bg-white rounded">
                         <div style="white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; line-height: 1.7; color: #333;">
                            @((MarkupString)FormatFullReport(selectedAsset.FullReport))
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 pt-0">
                    <button type="button" class="btn btn-dark px-4" @onclick="CloseModal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string tickerInput = "";
    private List<AssetDto>? assets;
    private AssetDto? selectedAsset;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try { assets = await Http.GetFromJsonAsync<List<AssetDto>>("api/favorites"); }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; }
    }

    private async Task AddFavorite()
    {
        if (string.IsNullOrWhiteSpace(tickerInput)) return;
        await Http.PostAsync($"api/favorites/{tickerInput}", null);
        tickerInput = "";
        await LoadData();
    }

    private async Task Remove(string ticker)
    {
        await Http.DeleteAsync($"api/favorites/{ticker}");
        await LoadData();
    }

    private async Task HandleKey(KeyboardEventArgs e) { if (e.Key == "Enter") await AddFavorite(); }
    private void OpenModal(AssetDto asset) => selectedAsset = asset;
    private void CloseModal() => selectedAsset = null;

    // --- NOVA L√ìGICA VISUAL "SMART STATUS" ---
    private string RenderSmartStatus(string text)
    {
        if (string.IsNullOrEmpty(text)) return "<span class='text-muted'>Analisando...</span>";
        
        // Tratamento de Erros
        if (text.Contains("429") || text.Contains("Cota")) 
            return "<span class='text-warning fw-bold'>‚ö†Ô∏è Aguardando Google (Cota)</span>";
        if (text.Contains("Erro")) 
            return $"<span class='text-danger fw-bold'>{text}</span>";

        // Detec√ß√£o de Sentimento para criar o "T√≠tulo Autom√°tico"
        string headerHtml = "";
        string cleanText = text;

        // L√≥gica: Se achar palavra chave, cria o header e remove a palavra do texto pra n√£o ficar repetitivo
        if (Regex.IsMatch(text, @"\b(compra|oportunidade|atrativo|upside)\b", RegexOptions.IgnoreCase))
        {
            headerHtml = "<span class='status-header text-success'>üöÄ ALERTA DE COMPRA.</span>";
        }
        else if (Regex.IsMatch(text, @"\b(cautela|risco|neutro|aten√ß√£o|monitorar)\b", RegexOptions.IgnoreCase))
        {
            headerHtml = "<span class='status-header text-warning' style='color: #fd7e14 !important;'>‚úã NEUTRO / CAUTELA.</span>";
        }
        else if (Regex.IsMatch(text, @"\b(venda|negativo|queda|fraco)\b", RegexOptions.IgnoreCase))
        {
            headerHtml = "<span class='status-header text-danger'>üîª FRACO.</span>";
        }
        else 
        {
            // Padr√£o se n√£o entender
            headerHtml = "<span class='status-header text-dark'>‚öñÔ∏è AN√ÅLISE.</span>";
        }

        return $"{headerHtml} <span class='status-body'>{cleanText}</span>";
    }

    private string FormatNewsCompact(string text)
    {
        if (string.IsNullOrEmpty(text)) return "-";
        // Extrai apenas os links [1] [2] etc
        var matches = Regex.Matches(text, @"(\[\d+\])\s*(https?://[^\s]+)");
        if (matches.Count == 0) return "<span class='text-muted small'>Sem fontes</span>";

        string html = "";
        foreach (Match m in matches)
        {
            html += $"<a href='{m.Groups[2].Value}' target='_blank' class='news-link me-1 fw-bold'>{m.Groups[1].Value}</a>";
        }
        return html;
    }

    private string FormatFullReport(string text)
    {
        if (string.IsNullOrEmpty(text)) return "Carregando...";
        return Regex.Replace(text, @"\*\*(.*?)\*\*", "<b>$1</b>");
    }

    public class AssetDto
    {
        public string Ticker { get; set; } = "";
        public decimal Price { get; set; }
        public decimal PeRatio { get; set; }
        public decimal DyPercentage { get; set; }
        public string AiAnalysis { get; set; } = "";
        public string FullReport { get; set; } = "";
        public string NewsSummary { get; set; } = "";
    }
}