@page "/"
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Smart Trader Dashboard</PageTitle>

<div class="container p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ðŸš€ Smart Trader AI <span class="fs-6 text-muted">| Dashboard Pro</span></h3>
        <span class="badge bg-success">Online</span>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="input-group mb-4 shadow-sm">
        <input type="text" @bind="tickerInput" class="form-control" placeholder="Ex: WEGE3" @onkeyup="HandleKey" />
        <button class="btn btn-primary" @onclick="AddFavorite">Monitorar Ativo</button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (assets != null && assets.Any())
    {
        <div class="card shadow-sm border-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Ativo</th>
                        <th>PreÃ§o</th>
                        <th>P/L</th>
                        <th>Resumo IA (50w)</th>
                        <th>NotÃ­cias</th>
                        <th>AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in assets)
                    {
                        <tr>
                            <td class="fw-bold">@item.Ticker</td>
                            <td>R$ @(item.Price.ToString("N2"))</td>
                            <td>@(item.PeRatio.ToString("N2"))</td>
                            <td class="small" style="max-width: 300px;">
                                @item.AiAnalysis
                                <br/>
                                <button class="btn btn-link btn-sm p-0 mt-1 text-decoration-none fw-bold" 
                                        @onclick="() => OpenModal(item)">
                                    ðŸ“Š Ver AnÃ¡lise Completa
                                </button>
                            </td>
                            <td class="small text-muted" style="max-width: 250px;">@item.NewsSummary</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => Remove(item.Ticker)">X</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (selectedAsset != null)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">ðŸ“ˆ AnÃ¡lise Profunda: <strong>@selectedAsset.Ticker</strong></h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body" style="white-space: pre-wrap;">
                    @selectedAsset.FullReport
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string tickerInput = "";
    private List<AssetDto>? assets;
    private AssetDto? selectedAsset; // Ativo selecionado para o modal
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try { assets = await Http.GetFromJsonAsync<List<AssetDto>>("api/favorites"); }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; }
    }

    private async Task AddFavorite()
    {
        if (string.IsNullOrWhiteSpace(tickerInput)) return;
        await Http.PostAsync($"api/favorites/{tickerInput}", null);
        tickerInput = "";
        await LoadData();
    }

    private async Task Remove(string ticker)
    {
        await Http.DeleteAsync($"api/favorites/{ticker}");
        await LoadData();
    }

    private async Task HandleKey(KeyboardEventArgs e) { if (e.Key == "Enter") await AddFavorite(); }

    // Controle do Modal
    private void OpenModal(AssetDto asset) => selectedAsset = asset;
    private void CloseModal() => selectedAsset = null;

    public class AssetDto
    {
        public string Ticker { get; set; } = "";
        public decimal Price { get; set; }
        public decimal PeRatio { get; set; }
        public decimal DyPercentage { get; set; }
        public string AiAnalysis { get; set; } = "";
        public string FullReport { get; set; } = ""; // Dado Completo
        public string NewsSummary { get; set; } = "";
    }
}